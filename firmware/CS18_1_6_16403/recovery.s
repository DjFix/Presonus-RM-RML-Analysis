echo "Beginning Recovery Process..."

# Alert LCD screen of a recovery
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x67   #g

# Erase the area where the kernel image will live
#erase 0x600A0000 0x604FFFFF
usb start

# Show 10% done
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x39   #9
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x39   #9
mw.b 0x01D0C000 0x67   #g

# Read the kernel image off the USB stick
# Load it into ram.  Copy byte by byte into flash
fatload usb 0:1 0xC0000000 uImage
#cp.b 0xC0000000 0x600A0000 $filesize

# Show 25% done
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x31   #1
mw.b 0x01C42000 0x39   #9
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x31   #1
mw.b 0x01D0C000 0x39   #9
mw.b 0x01D0C000 0x67   #g

# Erase where the file system lives.
# Load it into RAM
#erase 0x60500000 0x61BFFFFF

# Show 40% done
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x32   #2
mw.b 0x01C42000 0x38   #8
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x32   #2
mw.b 0x01D0C000 0x38   #8
mw.b 0x01D0C000 0x67   #g

fatload usb 0:1 0xC0000000 rootfs.img

# Show 50% done
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x33   #3
mw.b 0x01C42000 0x32   #2
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x33   #3
mw.b 0x01D0C000 0x32   #2
mw.b 0x01D0C000 0x67   #g

# Copy the file system into flash
#cp.b 0xC0000000 0x60500000 $filesize

# Done!  Return to the Please Wait screen
mw.b 0x01C42000 0x41   #A
mw.b 0x01C42000 0x30   #0
mw.b 0x01C42000 0x36   #6
mw.b 0x01C42000 0x36   #6
mw.b 0x01C42000 0x67   #g
mw.b 0x01D0C000 0x41   #A
mw.b 0x01D0C000 0x30   #0
mw.b 0x01D0C000 0x36   #6
mw.b 0x01D0C000 0x36   #6
mw.b 0x01D0C000 0x67   #g

# Light up Status LED 1 and 2 to indicate 
# completion.  This is a factory request
mw.w 0x01E260B8 0x0100
mw.w 0x01E260B8 0x0400
usb stop

